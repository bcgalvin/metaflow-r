<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Loading and Storing Data • metaflow</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Loading and Storing Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metaflow</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home fa-lg"></span></a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bcgalvin/metaflow-r"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Loading and Storing Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bcgalvin/metaflow-r/blob/HEAD/vignettes/data.Rmd" class="external-link"><code>vignettes/data.Rmd</code></a></small>
      <div class="d-none name"><code>data.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="store-and-load-objects-tofrom-a-known-s3-location">Store and load objects to/from a known S3 location<a class="anchor" aria-label="anchor" href="#store-and-load-objects-tofrom-a-known-s3-location"></a>
</h2>
<p>The examples below demonstrate how to use the Metaflow S3 client in
R. You can load data that has nothing to do with Metaflow as
follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">'s3://my-bucket/savin/tmp/external_data'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'an alien message:'</span>, <span class="va">res</span><span class="op">$</span><span class="fu">text</span><span class="op">(</span><span class="op">)</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Output:</span></span>
<span><span class="co"># an alien message: I know nothing about Metaflow</span></span></code></pre></div>
<p>If <code>S3</code> is initialized without any arguments, all
operations require a full S3 URL.</p>
<p>If you need to operate on multiple files, it may be more convenient
to specify a custom S3 prefix with the <code>s3root</code> argument:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo/'</span><span class="op">)</span></span>
<span><span class="va">s3</span><span class="op">$</span><span class="fu">put</span><span class="op">(</span><span class="st">'fruit'</span>, <span class="st">'pineapple'</span><span class="op">)</span></span>
<span><span class="va">s3</span><span class="op">$</span><span class="fu">put</span><span class="op">(</span><span class="st">'animal'</span>, <span class="st">'mongoose'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3_2</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">s3_2</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">'s3://my-bucket/savin/tmp/s3demo/fruit'</span><span class="op">)</span><span class="op">$</span><span class="fu">text</span><span class="op">(</span><span class="op">)</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Output:</span></span>
<span><span class="co"># pineapple</span></span></code></pre></div>
<p>If the requested URL does not exist, the <code>get</code> call will
raise an exception. You can call <code>get</code> with
<code>return_missing=TRUE</code> if you want to return a missing URL as
an ordinary result object, as described in the section below.</p>
<p>By default, <code>put_*</code> calls will overwrite existing keys in
S3. To avoid this behavior you can invoke your <code>put_*</code> calls
with <code>overwrite=FALSE</code>. Refer to the “Caution: Overwriting
data in S3” section for some of the pitfalls involved with overwriting
keys in S3.</p>
</div>
<div class="section level2">
<h2 id="the-s3-result-object">The S3 result object<a class="anchor" aria-label="anchor" href="#the-s3-result-object"></a>
</h2>
<p>All <code>get</code> operations return an <code>S3Object</code>,
backed by a temporary file on local disk, which exposes a number of
attributes about the object:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo/'</span><span class="op">)</span></span>
<span><span class="va">s3obj</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">'fruit'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'location'</span>, <span class="va">s3obj</span><span class="op">$</span><span class="va">url</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'key'</span>, <span class="va">s3obj</span><span class="op">$</span><span class="va">key</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'size'</span>, <span class="va">s3obj</span><span class="op">$</span><span class="va">size</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'local path'</span>, <span class="va">s3obj</span><span class="op">$</span><span class="va">path</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'bytes'</span>, <span class="va">s3obj</span><span class="op">$</span><span class="va">blob</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'unicode'</span>, <span class="va">s3obj</span><span class="op">$</span><span class="va">text</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'metadata'</span>, <span class="va">s3obj</span><span class="op">$</span><span class="va">metadata</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'content-type'</span>, <span class="va">s3obj</span><span class="op">$</span><span class="va">content_type</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'downloaded'</span>, <span class="va">s3obj</span><span class="op">$</span><span class="va">downloaded</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Output:</span></span>
<span><span class="co"># location s3://my-bucket/savin/tmp/s3demo/fruit</span></span>
<span><span class="co"># key fruit</span></span>
<span><span class="co"># size 9</span></span>
<span><span class="co"># local path /data/metaflow/metaflow.s3.5agi129m/metaflow.s3.one_file.pih_iseg</span></span>
<span><span class="co"># bytes b'pineapple'</span></span>
<span><span class="co"># unicode pineapple</span></span>
<span><span class="co"># metadata NULL</span></span>
<span><span class="co"># content-type application/octet-stream</span></span>
<span><span class="co"># downloaded TRUE</span></span></code></pre></div>
<p>The <code>S3Object</code> may also refer to an S3 URL that does not
correspond to an object in S3. These objects have <code><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists()</a></code>
method returning <code>FALSE</code>. Non-existent objects may be
returned by a <code>list_paths</code> call, if the result refers to an
S3 prefix, not an object. Listing operations also set
<code>downloaded()</code> method to return <code>FALSE</code>, to
distinguish them from operations that download data locally. Also
<code>get</code> and <code>get_many</code> may return non-existent
objects if you call these methods with an argument
<code>return_missing=TRUE</code>.</p>
<div class="section level3">
<h3 id="querying-objects-without-downloading-them">Querying objects without downloading them<a class="anchor" aria-label="anchor" href="#querying-objects-without-downloading-them"></a>
</h3>
<p>The above information about an object, like <code>size()</code> and
<code>metadata()</code>, can be useful even without downloading the file
itself. To just get the metadata, use the <code>info</code> and
<code>info_many</code> calls that work like <code>get</code> and
<code>get_many</code> but avoid the potentially expensive downloading
part. The info calls set <code>downloaded()</code> to return
<code>FALSE</code> in the result object.</p>
</div>
</div>
<div class="section level2">
<h2 id="operations-on-multiple-objects">Operations on multiple objects<a class="anchor" aria-label="anchor" href="#operations-on-multiple-objects"></a>
</h2>
<p>After you have instantiated the object given the right context
information, all <code>get</code> and <code>put</code> operations work
equally. The context is only used to construct an appropriate S3
URL.</p>
<p>Besides loading individual files with <code>$get()</code> and
<code>$put()</code> as shown above, <code><a href="../reference/S3.html">metaflow::S3</a></code> really
shines at operating on multiple files at once.</p>
<p>It is guaranteed that the list of <code>S3Object</code>s returned is
always in the same order as long as the underlying data does not change.
This can be important e.g. if you use <code><a href="../reference/S3.html">metaflow::S3</a></code> to feed
data for a model. The input data will be in a deterministic order so
results should be easily reproducible.</p>
<div class="section level3">
<h3 id="load-multiple-objects-in-parallel">Load multiple objects in parallel<a class="anchor" aria-label="anchor" href="#load-multiple-objects-in-parallel"></a>
</h3>
<p>Use <code>get_many()</code> to load arbitrarily many objects at
once:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo/'</span><span class="op">)</span></span>
<span><span class="va">objects</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">get_many</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'fruit'</span>, <span class="st">'animal'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># objects is a list of S3Object instances</span></span></code></pre></div>
<p>Here, <code>get_many()</code> loads objects in parallel, which is
much faster than loading individual objects sequentially. You can
achieve the optimal throughput with S3 only when you operate on many
files in parallel.</p>
<p>If one of the requested URLs doesn’t exist, the <code>get_many</code>
call will raise an exception. If you don’t want to fail all objects
because of missing URLs, call <code>get_many</code> with
<code>return_missing=TRUE</code>. This will make <code>get_many</code>
return missing URLs amongst other results. You can distinguish between
the found and not found URLs using the <code><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists()</a></code> method of
<code>S3Object</code>.</p>
</div>
<div class="section level3">
<h3 id="load-all-objects-recursively-under-a-prefix">Load all objects recursively under a prefix<a class="anchor" aria-label="anchor" href="#load-all-objects-recursively-under-a-prefix"></a>
</h3>
<p>We can load all objects under a given prefix:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">objects</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">get_recursive</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'s3://my-bucket/savin/tmp/s3demo'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># objects is a list of S3Object instances</span></span></code></pre></div>
<p>Note that <code>get_recursive</code> takes a list of prefixes. This
is useful for achieving the maximum level of parallelism when retrieving
data under multiple prefixes.</p>
<p>If you have specified a custom <code>s3root</code>, you can use
<code>get_all()</code> to get all files recursively under the given
prefix.</p>
</div>
<div class="section level3">
<h3 id="loading-parts-of-files">Loading parts of files<a class="anchor" aria-label="anchor" href="#loading-parts-of-files"></a>
</h3>
<p>A performance-sensitive application may want to read only a part of a
large file. Instead of a string, the <code>get</code> and
<code>get_many</code> calls also accept an object with <code>key</code>,
<code>offset</code>, <code>length</code> attributes that specify a part
of a file to download. You can use a list with these attributes for this
purpose in R.</p>
<p>This example loads two 1KB chunks of a file in S3:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">URL</span> <span class="op">&lt;-</span> <span class="st">'s3://ursa-labs-taxi-data/2014/12/data.parquet'</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">get_many</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key<span class="op">=</span><span class="va">URL</span>, offset<span class="op">=</span><span class="fl">0</span>, length<span class="op">=</span><span class="fl">1024</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key<span class="op">=</span><span class="va">URL</span>, offset<span class="op">=</span><span class="fl">1024</span>, length<span class="op">=</span><span class="fl">1024</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">obj</span> <span class="kw">in</span> <span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="fu">path</span><span class="op">(</span><span class="op">)</span>, <span class="va">obj</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="store-multiple-objects-or-files">Store multiple objects or files<a class="anchor" aria-label="anchor" href="#store-multiple-objects-or-files"></a>
</h3>
<p>If you need to store multiple objects, use <code>put_many</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">many</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>first_key <span class="op">=</span> <span class="st">'foo'</span>, second_key <span class="op">=</span> <span class="st">'bar'</span><span class="op">)</span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo_put/'</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">put_many</span><span class="op">(</span><span class="va">many</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># result is a list of (key, url) pairs for uploaded objects</span></span></code></pre></div>
<p>You may want to store more data to S3 than what you can fit in memory
at once. This is a good use case for <code>put_files</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="st">'first datum'</span>, <span class="st">'/tmp/1'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="st">'second datum'</span>, <span class="st">'/tmp/2'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo_put/'</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">put_files</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key<span class="op">=</span><span class="st">'first_file'</span>, path<span class="op">=</span><span class="st">'/tmp/1'</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key<span class="op">=</span><span class="st">'second_file'</span>, path<span class="op">=</span><span class="st">'/tmp/2'</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># result is a list of (key, url) pairs for uploaded files</span></span></code></pre></div>
<p>Objects are stored in S3 in parallel for maximum throughput.</p>
</div>
<div class="section level3">
<h3 id="listing-objects-in-s3">Listing objects in S3<a class="anchor" aria-label="anchor" href="#listing-objects-in-s3"></a>
</h3>
<p>To get objects with <code>get</code> and <code>get_many</code>, you
need to know the exact names of the objects to download. S3 is optimized
for looking up specific names, so it is preferable to structure your
code around known names. However, sometimes this is not possible and you
need to check first what is available in S3.</p>
<p>Metaflow provides two ways to list objects in S3:
<code>list_paths</code> and <code>list_recursive</code>. The first
method provides the next level of prefixes (directories) in S3, directly
under the given prefix. The latter method provides all objects under the
given prefix. Since <code>list_paths</code> returns a subset of prefixes
returned by <code>list_recursive</code>, it is typically a much faster
operation.</p>
<p>Here’s an example: First, let’s create files in S3 in a hierarchy
like this:</p>
<pre><code><span><span class="va">first</span><span class="op">/</span><span class="va">a</span><span class="op">/</span><span class="va">object1</span></span>
<span><span class="va">first</span><span class="op">/</span><span class="va">b</span><span class="op">/</span><span class="va">x</span><span class="op">/</span><span class="va">object2</span></span>
<span><span class="va">second</span><span class="op">/</span><span class="va">c</span><span class="op">/</span><span class="va">object3</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">many</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="st">'first/a/object1'</span> <span class="op">=</span> <span class="st">'data'</span>,</span>
<span>  <span class="st">'first/b/x/object2'</span> <span class="op">=</span> <span class="st">'data'</span>,</span>
<span>  <span class="st">'second/c/object3'</span> <span class="op">=</span> <span class="st">'data'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo_list/'</span><span class="op">)</span></span>
<span><span class="va">s3</span><span class="op">$</span><span class="fu">put_many</span><span class="op">(</span><span class="va">many</span><span class="op">)</span></span></code></pre></div>
<p>Next, let’s list all directories using <code>list_paths</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo_list/'</span><span class="op">)</span></span>
<span><span class="va">keys</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">list_paths</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">key</span> <span class="kw">in</span> <span class="va">keys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">key</span><span class="op">$</span><span class="fu">key</span><span class="op">(</span><span class="op">)</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Output:</span></span>
<span><span class="co"># first</span></span>
<span><span class="co"># second</span></span></code></pre></div>
<p>You can list multiple prefixes in parallel by giving
<code>list_paths</code> a list of prefixes:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo_list/'</span><span class="op">)</span></span>
<span><span class="va">keys</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">list_paths</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'first'</span>, <span class="st">'second'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">key</span> <span class="kw">in</span> <span class="va">keys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">key</span><span class="op">$</span><span class="fu">key</span><span class="op">(</span><span class="op">)</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Output:</span></span>
<span><span class="co"># a</span></span>
<span><span class="co"># b</span></span>
<span><span class="co"># c</span></span></code></pre></div>
<p>Listing may return either prefixes (directories) or objects. To
distinguish between the two, use the <code><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists()</a></code> method of the
returned <code>S3Object</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo_list/'</span><span class="op">)</span></span>
<span><span class="va">keys</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">list_paths</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'first/a'</span>, <span class="st">'first/b'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">key</span> <span class="kw">in</span> <span class="va">keys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">key</span><span class="op">$</span><span class="fu">key</span><span class="op">(</span><span class="op">)</span>, <span class="kw">if</span> <span class="op">(</span><span class="va">key</span><span class="op">$</span><span class="fu">exists</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="st">'object'</span> <span class="kw">else</span> <span class="st">'prefix'</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Output:</span></span>
<span><span class="co"># object1 object</span></span>
<span><span class="co"># x prefix</span></span></code></pre></div>
<p>If you want all objects under the given prefix, use the
<code>list_recursive</code> method:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://metaflow.org/" class="external-link">metaflow</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">s3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/S3.html">S3</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>s3root<span class="op">=</span><span class="st">'s3://my-bucket/savin/tmp/s3demo_list/'</span><span class="op">)</span></span>
<span><span class="va">keys</span> <span class="op">&lt;-</span> <span class="va">s3</span><span class="op">$</span><span class="fu">list_recursive</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">key</span> <span class="kw">in</span> <span class="va">keys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">key</span><span class="op">$</span><span class="fu">key</span><span class="op">(</span><span class="op">)</span>, <span class="st">'\n'</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Output:</span></span>
<span><span class="co"># first/a/object1</span></span>
<span><span class="co"># first/b/x/object2</span></span>
<span><span class="co"># second/c/object3</span></span></code></pre></div>
<p>Similar to <code>list_paths</code>, <code>list_recursive</code> can
take a list of prefixes to process in parallel.</p>
<p>A common pattern is to list objects using either
<code>list_paths</code> or <code>list_recursive</code>, filter out some
keys from the listing, and provide the pruned list to
<code>get_many</code> for fast parallelized downloading.</p>
</div>
</div>
<div class="section level2">
<h2 id="caution-overwriting-data-in-s3">Caution: Overwriting data in S3<a class="anchor" aria-label="anchor" href="#caution-overwriting-data-in-s3"></a>
</h2>
<p>You should avoid overwriting data in the same key (URL) in S3. S3
guarantees that new keys always reflect the latest data. In contrast,
when you overwrite data in an existing key, there is a short period of
time when a reader may see either the old version or the new version of
the data.</p>
<p>In particular, when you use <code><a href="../reference/S3.html">metaflow::S3</a></code> in your
Metaflow flows, make sure that every task and step writes to a unique
key. Otherwise you may find results unpredictable and inconsistent.</p>
<p>Note that specifying <code>overwrite=FALSE</code> in your
<code>put_*</code> calls changes the behavior of S3 slightly compared to
the default mode of <code>overwrite=TRUE</code>. There may be a small
delay (typically in the order of milliseconds) before the key becomes
available for reading.</p>
<p>This is an important reason to rely on Metaflow artifacts, which
handle this complication for you, whenever possible. If you absolutely
need to handle this by yourself, one way to guarantee uniqueness is to
use <code>current$task_id</code> from the <code>current</code> module as
a part of your S3 keys.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bryan Galvin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
