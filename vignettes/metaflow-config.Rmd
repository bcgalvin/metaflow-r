---
title: "Managing Metaflow Configurations in R"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Managing Metaflow Configurations in R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

Configuration management is a crucial aspect of maintaining and scaling data science workflows. The `MetaflowConfig` class provides a robust solution for managing Metaflow configurations in R, offering a streamlined interface for handling different environments, accessing and modifying configuration values, and applying environment variable overrides.

## Installation

You can install the development version of the package containing `MetaflowConfig` from GitHub:

```{r, eval=FALSE}
# Install the development version from GitHub
# install.packages("devtools")
devtools::install_github("yourusername/metaflowConfigPackage")
```

## Getting Started with MetaflowConfig

### Initializing the Config Object

To begin using `MetaflowConfig`, you first need to create an instance of the class. You can do this with default settings or by specifying a custom configuration file and environment.

```{r}
library(metaflow)  # Use the actual package name

# Initialize with default settings
config <- MetaflowConfig$new()

# Initialize with a specific active environment
config <- MetaflowConfig$new(active_env = "development")
```

### Configuration Management

The `MetaflowConfig` class manages configurations internally and allows you to set or get configuration values programmatically. You can also override configurations using environment variables prefixed with `METAFLOW_`.

## Accessing Configuration Values

### Retrieving Values with `get()`

You can retrieve configuration values using the `get()` method. If a key is not found, you can provide a default value.

```{r}
# Set a configuration value for demonstration
config$set("datastore_sysroot_s3", "s3://my-bucket")

# Get the configuration value
datastore_root <- config$get("datastore_sysroot_s3", default = "s3://default-bucket")
```


### Environment Variable Overrides

Configuration values can be overridden by environment variables prefixed with `METAFLOW_`. This is useful for setting sensitive information or environment-specific values.

```{r}
Sys.setenv(METAFLOW_KEY1 = "override_value")
# 'key1' will return 'override_value' instead of the value from the config file
value <- config$get("key1")
```

## Modifying Configuration Values

### Setting Values with `set()`

You can update existing configuration values or add new ones using the `set()` method.

```{r}
# Set or update a configuration value
config$set("default_datastore", "s3")
```

### Persisting Configurations to Environment Variables

After modifying configurations, you can persist them by setting corresponding environment variables using the `save()` method.

```{r}
# Persist configurations to environment variables
config$save()
```

**Note:** The `save()` method sets environment variables based on the current configurations for the active environment.

## Environment Management

### Switching Environments with `switch_env()`

You can change the active environment using the `switch_env()` method.

```{r}
# Switch to the 'production' environment
config$switch_env("production")
```

If the specified environment doesn't exist, it will be created and initialized by inheriting configurations from the "default" environment.

### Active Environment Detection

The `MetaflowConfig` class determines the active environment during initialization based on the following order:

1. The `active_env` parameter provided during initialization.
2. The `R_CONFIG_ACTIVE` environment variable.
3. Defaults to `"default"` if neither is set.

## Validation and Error Handling

### Validating Keys with `validate_key()`

You can check if a key exists in the active environment using the `validate_key()` method.

```{r}
# Validate if 'default_datastore' is a valid key
is_valid <- config$validate_key("default_datastore")
```

### Handling Missing Keys and Environments

`MetaflowConfig` provides informative error messages when attempting to access non-existent keys or environments.

## Inspecting Configurations

### Printing Configurations with `print()`

You can display the configurations of the active environment using the `print()` method.

```{r}
# Print configurations
config$print()
```

## Best Practices

1. **Sensitive Data Management**: Avoid storing sensitive data in configuration files. Use environment variables for secrets instead.

2. **Configuration Simplicity**: Keep configurations simple and handle complex logic in R code.

3. **Version Control**: Track configuration files in version control systems, but exclude files containing sensitive data.

## Limitations of the Current Version

1. **No support for external configuration files:** Configurations are managed in-memory and via environment variables, without loading from or saving to external files.

2. **No support for nested keys:** The `get()` method does not support accessing nested configuration values using dot notation.

3. **Limited validation:** The current version validates keys and values based on an internal specification but does not support custom schemas.

4. **No configuration persistence across sessions:** Unless environment variables are set using `save()`, configurations are not persisted after the R session ends.

5. **No support for multi-key operations:** Methods for setting or getting multiple configuration values simultaneously are not available.

6. **Limited error handling:** Error messages provide basic information but may not cover all edge cases.

## Conclusion

The `MetaflowConfig` class provides a powerful and flexible way to manage Metaflow configurations in R. By using this class, you can easily handle different environments, access and modify configuration values, and ensure consistent configuration management across your Metaflow projects.

For more detailed information on the `MetaflowConfig` class and its methods, please refer to the package documentation.

## Appendix: Full Example

Here's a comprehensive example that demonstrates the main features of `MetaflowConfig`:

```{r}
library(metaflow)

# Initialize with a specific active environment
config <- MetaflowConfig$new(active_env = "development")

# Set a new configuration value
config$set("debug_mode", TRUE)

# Get a configuration value
debug_mode <- config$get("debug_mode", default = FALSE)

# Switch to the 'production' environment
config$switch_env("production")

# Set an environment variable to override a configuration
Sys.setenv(METAFLOW_API_ENDPOINT = "https://api.example.com")

# Get a value with environment variable override
api_endpoint <- config$get("api_endpoint", default = "https://default-api.com")

# Validate a key
if (config$validate_key("feature_flags")) {
  feature_flags <- config$get("feature_flags")
}

# Persist configurations to environment variables
config$save()

# Print the current configurations
config$print()
```

```{r}
sessionInfo()
```
